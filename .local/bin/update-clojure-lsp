#!/usr/bin/env sh

set -e

local_bin_folder="$HOME/.local/bin"

releases_path=https://api.github.com/repos/snoe/clojure-lsp/releases/latest

download_url=$(curl -L -s $releases_path | jq '.assets[] | select(.name | contains("clojure-lsp-native-linux-amd64.zip")) | .browser_download_url')

if [ -z "$download_url" ]; then
  echo something went wrong parsing the download_url...
  exit 1
fi

echo "Download url: $download_url"
  
if [ -f $local_bin_folder/clojure-lsp.bkp ]; then
  echo "Delete old backup"
  rm $local_bin_folder/clojure-lsp.bkp
fi

if [ -f $local_bin_folder/clojure-lsp ]; then
  echo "Backup previous binary"
  mv $local_bin_folder/clojure-lsp $local_bin_folder/clojure-lsp.bkp
fi

download_cmd="curl \"$download_url\" -o /tmp/clojure-lsp.zip -L"
echo "Download cmd: $download_cmd"
eval $download_cmd

unzip -d "$local_bin_folder" /tmp/clojure-lsp.zip

chmod +x "$local_bin_folder/clojure-lsp"

if [ -f $local_bin_folder/clojure-lsp.bkp ]; then
  echo "Move backup to /tmp folder"
  mv $local_bin_folder/clojure-lsp.bkp /tmp
fi

echo "Done"
